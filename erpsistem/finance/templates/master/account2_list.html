{% extends "base.html" %}
{% block content %}
<div class="container-fluid mb-2">
    <h5 class="text-gray-800"><strong>Chart of Account #2</strong></h5>
    <hr>
    <div class="mb-3">
        <button class="btn btn-sm btn-primary" onclick="openForm('add')"><i class="fas fa-fw fa-plus-circle"></i> Add Account #1</button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <table class="table table-sm table-bordered" id="myTables" style="font-size:13px;">
                <thead class="table-light text-center">
                    <tr>
                        <th>No</th>
                        <th>Account Code</th>
                        <th>Account #2 Code</th>
                        <th>Account #2 Name</th>
                        <th>Active</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for acc in data %}
                    <tr class="text-center">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ acc.account1code }}</td>
                        <td>{{ acc.account2_code }}</td>
                        <td class="text-left">{{ acc.account2_name }}</td>
                        <td>{{ acc.is_active|yesno:"Yes,No" }}</td>
                        <td>
                            <button class="btn btn-xs btn-warning py-0 px-1" style="font-size: 0.7rem;" onclick="editForm({{ acc.account2_id }})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-xs btn-danger py-0 px-1" style="font-size: 0.7rem;" onclick="deleteForm({{ acc.account2_id }})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Form -->
<div class="modal fade" id="modalForm" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle">Add Account #2</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="account2_id">
        <div class="form-group mb-2">
          <input type="text" class="form-control" id="account1code" placeholder="Account 1 code">
        </div>
        <div class="form-group mb-2">
          <input type="text" class="form-control" id="account2_code" placeholder="Account #2 code">
        </div>
        <div class="form-group mb-2">
          <input type="text" class="form-control" id="account2_name" placeholder="Account #2 name">
        </div>
        <div class="form-group">
          <select class="form-control" id="is_active">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveForm()">Save</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
let mode = 'add';

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function openForm(type) {
    mode = type;
    document.getElementById('modalTitle').innerText = 'Add Account #2';
    document.getElementById('account2_id').value = '';
    document.getElementById('account1code').value = '';
    document.getElementById('account2_code').value = '';
    document.getElementById('account2_name').value = '';
    document.getElementById('is_active').value = '1';
    new bootstrap.Modal(document.getElementById('modalForm')).show();
}

function editForm(id) {
    fetch(`/finance/account2/${id}/json/`)
        .then(res => {
            if (!res.ok) throw new Error("Failed to fetch data");
            return res.json();
        })
        .then(data => {
            mode = 'edit';
            document.getElementById('modalTitle').innerText = 'Edit Account #2';
            document.getElementById('account2_id').value = id;
            document.getElementById('account1code').value = data.account1code;
            document.getElementById('account2_code').value = data.account2_code;
            document.getElementById('account2_name').value = data.account2_name;
            document.getElementById('is_active').value = data.is_active;
            new bootstrap.Modal(document.getElementById('modalForm')).show();
        })
        .catch(err => alert("Error loading data: " + err.message));
}

function saveForm() {
    const id = document.getElementById('account2_id').value;
    const payload = {
        account1code: document.getElementById('account1code').value,
        account2_code: document.getElementById('account2_code').value,
        account2_name: document.getElementById('account2_name').value,
        is_active: document.getElementById('is_active').value,
    };

    const url = mode === 'add' ? '/finance/account2/add/' : `/finance/account2/update/${id}/`;

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.status) {
            location.reload();
        } else {
            alert("Save failed: " + (data.error || "Unknown error"));
        }
    })
    .catch(err => {
        alert("Network error: " + err.message);
    });
}

function deleteForm(id) {
    if (confirm("Are you sure you want to delete this account?")) {
        fetch(`/finance/account2/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(res => {
            if (!res.ok) throw new Error("Server error: " + res.status);
            return res.json(); // error di sini jika respon bukan JSON
        })
        .then(data => {
            if (data.status) {
                location.reload();
            } else {
                alert("Delete failed: " + (data.error || "Unknown error"));
            }
        })
        .catch(err => {
            alert("Error deleting data: " + err.message);
        });
    }
}
</script>
{% endblock %}
