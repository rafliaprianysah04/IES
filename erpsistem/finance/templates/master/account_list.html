{% extends "base.html" %}
{% block content %}
<div class="container-fluid mb-2">
    <h5 class="text-gray-800"><strong>Chart of Account</strong></h5>
    <hr>
    <div class="mb-3">
        <button class="btn btn-sm btn-primary" onclick="openForm('add')"><i class="fas fa-fw fa-plus-circle"></i> Add Account</button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <table class="table table-sm table-bordered" id="myTables" style="font-size:13px;">
                <thead class="table-light text-center">
                    <tr>
                        <th>No</th>
                        <th>Account Code</th>
                        <th>Account Name</th>
                        <th>Active</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for acc in data %}
                    <tr class="text-center">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ acc.account_code }}</td>
                        <td class="text-left">{{ acc.account_name }}</td>
                        <td>{{ acc.is_active|yesno:"Yes,No" }}</td>
                        <td>
                            <button class="btn btn-xs btn-warning py-0 px-1" style="font-size: 0.7rem;" onclick="editForm({{ acc.account_id }})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-xs btn-danger py-0 px-1" style="font-size: 0.7rem;" onclick="deleteForm({{ acc.account_id }})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Form -->
<div class="modal fade" id="modalForm" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle">Add Account</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="account_id">
        <div class="form-group mb-2">
          <input type="text" class="form-control" id="account_code" placeholder="Account code">
        </div>
        <div class="form-group mb-2">
          <input type="text" class="form-control" id="account_name" placeholder="Account name">
        </div>
        <div class="form-group">
          <select class="form-control" id="is_active">
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveForm()">Save</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<script>
let mode = 'add';
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Apakah cookie dimulai dengan "csrftoken="
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function getCSRFToken() {
    return document.querySelector('[name=csrf-token]').content;
}

function openForm(type) {
    mode = type;
    document.getElementById('modalTitle').innerText = 'Add Account';
    document.getElementById('account_id').value = '';
    document.getElementById('account_code').value = '';
    document.getElementById('account_name').value = '';
    document.getElementById('is_active').value = '1';
    new bootstrap.Modal(document.getElementById('modalForm')).show();
}

function editForm(id) {
    fetch(`/finance/account/${id}/json/`)
        .then(res => {
            if (!res.ok) throw new Error("Failed to fetch account data");
            return res.json();
        })
        .then(data => {
            mode = 'edit';
            document.getElementById('modalTitle').innerText = 'Edit Account';
            document.getElementById('account_id').value = id;
            document.getElementById('account_code').value = data.account_code;
            document.getElementById('account_name').value = data.account_name;
            document.getElementById('is_active').value = data.is_active;
            new bootstrap.Modal(document.getElementById('modalForm')).show();
        })
        .catch(err => alert("Error loading account data: " + err.message));
}

function saveForm() {
    const id = document.getElementById('account_id').value;
    const payload = {
        account_code: document.getElementById('account_code').value,
        account_name: document.getElementById('account_name').value,
        is_active: document.getElementById('is_active').value,
    };

    const url = mode === 'add' ? '/finance/account/add/' : `/finance/account/update/${id}/`;

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        console.log("Response dari server:", data);
        if (data.status) {
            location.reload();
        } else {
            alert("Save failed. " + (data.error || "Please try again."));
        }
    })
    .catch(err => {
        console.error("Fetch error:", err);
        alert("Network error. Please try again.");
    });
}

function deleteForm(id) {
    if (confirm("Are you sure you want to delete this account?")) {
        fetch(`/finance/account/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(res => {
            if (!res.ok) throw new Error("Failed to delete account");
            return res.json();
        })
        .then(data => {
            if (data.status) {
                location.reload();
            } else {
                alert("Delete failed. Please try again.");
            }
        })
        .catch(err => alert("Error deleting: " + err.message));
    }
}
</script>
{% endblock %}
