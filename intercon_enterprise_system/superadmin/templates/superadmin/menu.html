{% extends 'superadmin/base.html' %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Tabel Menu -->
        <div class="col-md-7 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">Data Menu</div>
                <div class="card-body mt-2">
                    <div class="table-responsive">
                        <table class="table table-striped" id="menuTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nama Menu</th>
                                    <th>Ikon</th>
                                    <th>App Id</th>
                                    <th>Sort</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="menuData">
                                <!-- diisi via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Input Menu -->
        <div class="col-md-5 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white">Form Menu</div>
                <div class="card-body mt-2">
                    <form id="menuForm">
                        <input type="hidden" id="menu_id">
                        <div class="mb-2">
                            <label>Nama Menu</label>
                            <input type="text" id="nama_menu" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label>Ikon Menu</label>
                            <input type="text" id="icon_menu" class="form-control" placeholder="ex: fas fa-home">
                        </div>
                        <div class="mb-3">
                            <label for="app_id" class="form-label">App ID</label>
                            <input type="text" class="form-control" id="app_id" placeholder="Masukkan ID aplikasi">
                        </div>                    
                        <div class="mb-2">
                            <label>Sort (Urutan)</label>
                            <input type="number" id="sort" class="form-control" min="1" required>
                        </div>
                        <div class="mb-2">
                            <label>Status</label><br>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_active" checked>
                                <label class="form-check-label">Aktif</label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-success">Simpan</button>
                            <button type="reset" class="btn btn-secondary" id="resetBtn">Reset</button>
                        </div>
                    </form>
                    <div id="notif" class="mt-2 text-success d-none"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const menuApi = "{% url 'superadmin:menu_api' %}";
    let menuTable;

    function loadMenus() {
        fetch(menuApi)
            .then(res => res.json())
            .then(data => {
                // Hancurkan datatable jika sudah ada
                if ($.fn.dataTable.isDataTable('#menuTable')) {
                    menuTable.clear().destroy();
                }

                let rows = '';
                data.data.forEach((m, i) => {
                    rows += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${m.nama_menu}</td>
                            <td><i class="${m.icon_menu}"></i> ${m.icon_menu}</td>
                            <td>${m.app_id}</td>
                            <td>${m.sort}</td>
                            <td>${m.is_active ? 'Aktif' : 'Tidak Aktif'}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick='editMenu(${JSON.stringify(m).replace(/"/g, "&quot;")})'>Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteMenu(${m.id})">Hapus</button>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('menuData').innerHTML = rows;
                menuTable = new DataTable('#menuTable');
            });
    }

    function showNotif(msg, color = 'success') {
        const notif = document.getElementById('notif');
        notif.className = `mt-2 text-${color}`;
        notif.textContent = msg;
        notif.classList.remove('d-none');
        setTimeout(() => notif.classList.add('d-none'), 3000);
    }

    document.getElementById('menuForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const nama = document.getElementById('nama_menu').value.trim();
        const icon = document.getElementById('icon_menu').value.trim();
        const app_id = document.getElementById('app_id').value.trim();
        const sort = document.getElementById('sort').value.trim();

        if (!nama || !icon || !sort) {
            showNotif('Semua kolom wajib diisi.', 'danger');
            return;
        }

        const payload = {
            id: document.getElementById('menu_id').value || null,
            nama_menu: nama,
            icon_menu: icon,
            app_id: app_id,
            sort: sort,
            is_active: document.getElementById('is_active').checked
        };

        fetch(menuApi, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            showNotif(data.status === 'created' ? 'Menu ditambahkan' : 'Menu diperbarui');
            loadMenus();
            document.getElementById('menuForm').reset();
            document.getElementById('menu_id').value = '';
        });
    });

    function editMenu(data) {
        document.getElementById('menu_id').value = data.id;
        document.getElementById('nama_menu').value = data.nama_menu;
        document.getElementById('icon_menu').value = data.icon_menu;
        document.getElementById('app_id').value = data.app_id || '';
        document.getElementById('sort').value = data.sort;
        document.getElementById('is_active').checked = data.is_active;
    }

    function deleteMenu(id) {
        if (!confirm('Yakin ingin menghapus menu ini?')) return;
        fetch(menuApi, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        })
        .then(res => res.json())
        .then(() => {
            showNotif('Menu berhasil dihapus');
            loadMenus();
        });
    }

    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('menu_id').value = '';
    });

    document.addEventListener('DOMContentLoaded', loadMenus);
</script>

{% endblock %}
